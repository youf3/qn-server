name: BuildandTest

on:
  workflow_dispatch:

jobs:
  BuildandTest:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.QN_RO_PAT }}
          ref: OFC_demo
          path: quantnet_server

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.QN_RO_PAT }}
          repository: quant-net/quant-net-mq
          ref: schema-updates
          path: quantnet_mq

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Display Python version
        run: |
            python -c "import sys; print(sys.version)"

      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.12.0
        with:
          mongodb-version: 8.0

      - name: Build
        run: |
          ls -al
          cd quantnet_mq
          pip install -e .
          cd ../quantnet_server
          pip3 install -e .

      - name: Tests
        run: |
          cd quantnet_server
          pytest -sv